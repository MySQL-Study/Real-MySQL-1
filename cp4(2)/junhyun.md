## innodb 버퍼풀  
- 디스크의 데이터 파일이나 인덱스 정보를 캐시해 두는 공간

### 버퍼풀의 크기 설정
- 5.7 부터 innodb_buffer_pool_size로 조절 가능. 운영체제의 전체 메모리의 50%부터 시작해 차츰 늘려가는 방법 추천.

### 버퍼풀의 구조
- 버퍼풀을 페이지 크기의 조각으로 나누어 관리
- 페이지 크기 조각 관리를 위해 LRU 리스트, Flush 리스트, Free 리스트 3개의 자료구조를 관리
- 프리리스트
  - 비어있는 페이지 목록
  - 사용자의 쿼리가 새롭게 디스크의 데이터 페이지를 읽어와야 하는 경우 사용됨.
- LRU 리스트
  - LRU(old서브리스트)+ MRU(new서브리스트)
  - 페이지가 자주 이용되면 mru에서 생존
  - 사용되지 않으면 lru끝으로 밀려나며 버퍼풀에서 제거됨.
- 플러시 리스트
  - 디스크로 동기화되지 않은 페이지(더티 페이지)의 변경 시점 기준의 페이지 목록 관리
  - 변경 -> 리두로그에 기록(리두로그의 각 엔트리는 데이터 페이지와 연결), 데이터 페이지에도 기록
  - innodb스트로지 엔진이 체크포인트 발생시켜 디스크의 리두 로그와 데이터 페이지 상태 동기화

### 버퍼풀과 리두로그
innodb버퍼풀은 캐시와 쓰기 버퍼링 두가지 용도가 있음  
버퍼풀 공간 늘림 = 캐시 향상  
쓰기 버퍼링 향상시키려면 리두로그와 관련됨  
버퍼풀은 클린페이지, 더티페이지 둘다 있음  
더티페이지는 언젠간 기록되어야하고 무한정 버퍼풀에 머무를 수 없음  
리두로그는 1개 이상의 고정 크기파일을 연결해 순환고리처럼 사용  
데이터 변경이 계속 발생하면 이전 로그엔트리는 어느순간 새로운 로그 엔트리로 덮어 쓰임  
innodb스토리지 엔진이 전체 리두 로그 파일에서 재사용 가능한 공간, 재사용 불가능한 공간(Active Redo Log)을 관리  
리두 로그 파일 공간은 재사용, 로그 포지션은 계속 증가(LSN)  
innodb스토리지 엔진은 주기적으로 체크포인트 이벤트 발생시켜 리두 로그와 버퍼풀의 더티페이지를 디스크로 동기화함  
가장 최근 체크포인트 지점의 LSN = 활성 리두 공간의 시작점 (활성 리두 로그 공간의 마지막은 계속 증가해 체크포인트와 무관)  
마지막 리투로그 엔트리 LSN - 가장 최근 체크포인트의 LSN = 체크포인트 에이지 = 확성 리두 로그 공간의 크기  
체크포인트 발생 -> 체크포인트 LSN보다 작은 리두 로그 엔트리와 관련된 더티페이지 디스크로 동기화, 체크포인트 LSN보다 작은 LSN값을 가진 리두 로그 엔트리도 동기화  

- 예시
  - 버퍼풀 100GB, 리두로그 100MB
    - 평균 리두 로그 엔트리가 4KB라면, 100MB/4KB = 25600개의 더티 페이지(16KB가정)만 버퍼풀에 보관 가능
    - 허용 가능 전체 더티페이지 400MB수준
    - 버퍼풀은 겁나 큰데 쓰기 버퍼링을 위한 효과 없음
  - 버퍼풀 100MB, 리두로그 100GB
    - 1번과 동일한 상황
    - 400GB 정도의 더티 페이지 보관 가능
    - 버퍼풀이 100MB라 최대 허용 100MB
  
1번 예시는 잘못된 설정
2번 예시는 급작스러운 디스크 쓰기 발생 가능성 높음
버퍼풀에 더티페이지 비율이 너무 높은 상태에서 버퍼풀이 필요해지면 innodb스트로지 엔진이 많은 더티페이지를 한번에 기록해야함.
버퍼풀 보다 리두 로그는 훨씬 작은 공간만 있으면 됨.

### 버퍼풀 플러시
- 더티 페이지를 디스크로 동기화하는 작업
- 특별히 별도 조정 필요 없음
- 플러시 리스트 플러시, LRU 리스트 플러시를 백그라운드로 실행
- `플러시 리스트 플러시`
  - 리두로그 공간 재활용을 위해 플러시 리스트 플러시 함수를 호출해 플러시 리스트에서 오래전에 변경된 데이터 페이부터 디스크에 동기화
- `LRU 리스트 플러시`
  - LRU리스트에서 사용 빈도 낮은 것을 제거

### 버퍼풀 상태 백업 및 복구
`워밍업`: 디스크에 데이터가 버퍼풀에 적재된 상태
- 수동으로 백업 복구가 여간 쉬운 일이 아니다.
- innodb스토리지 엔진은 MySQL서버가 셧다운 되기 직전에 버퍼풀을 백업
- MySQL서버가 시작되면 이전 버퍼풀 상태를 복구
- `innodb_buffer_pool_dump_at_shutdown`, `innodb_buffer_pool_load_at_startup` 을 MySQL설정 파일에 추가하면 됨.  

### 버퍼풀의 적재 내용 확인

## Double Write Buffer
변경된 내용만 기록하는 리두 로그때문에 더테페이지를 플러시 할때 일부만 기록되는 Partial-page, Torn-page 현상 발생 가능  
이를 방지하기 위해 `Double Write` 기법 이용
디스크에 쓸 더티페이지들을 묶어 Double Write Buffer에 먼저 기록하고 디스크에 기록  
플로시 중 비정상 발생할때만 Double Write Buffer와 데이터 파일의 페이지를 비교해 다른 것을 복사  
Double Write 버퍼 활성화가 HDD에서는 부담 안 되지만, SSD에서는 부담 될 수 있음. 
무결성이 매우 중요할때만 활성화 고려  
innodb_flush_log_at_trx_commit != 1이면 Double Write Buffer 비활성화  

## 언두 로그
### 언두로그 모니터링
이전 이름 김철수
```mysql
UPDATE member SET name='홍길동' WHERE id=1;
```
- 실제 데이터 파일은 홍길동으로 변경됨.
- 언두로그에 김철수 백업됨.
- 언두로그는 롤백 대비용, 높은 동시성 제공
- 언두로그 많이 쌓이면 문제됨.

서버의 언두 로그 건수 확인. 언두 로그 급증 여부 모니터링하는 것이 좋다.
```mysql
SELECT count FROM information_schema.innodb_metrics WHERE SUBSYSTEM='transaction' AND NAME='trx_rseg_history_len';
```
### 언두 테이블스페이스 관리

## 체인지 버퍼

## redo log 및 로그 버퍼

## 어댑티브 해시 인덱스

## InnoDB 스토리지 엔진과 비교

# MySQL 로그 파일